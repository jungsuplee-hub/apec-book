<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APEC Meeting Rooms - Booking</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="icon" type="image/x-icon" href="https://www.apecceosummitkorea2025.com/images/favicon.ico" />
  <style>
    #dateField .date-field{position:relative}
    #dateField .date-open-btn{
      position:absolute;
      left:14px;
      top:50%;
      transform:translateY(-50%);
      width:38px;
      height:38px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:10px;
      border:1px solid var(--line);
      background:#0f1828;
      color:var(--muted);
      cursor:pointer;
    }
    #dateField input[type="date"]{ padding-left:62px }
    .hidden{display:none}
    .button.primary{font-size:var(--fs-lg)}
  </style>
</head>
<body>
<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <a href="/" class="brand-logo" aria-label="Home">
        <img src="/static/logo-apec.png" alt="APEC" />
      </a>
    </div>
    <div class="topbar-title">MEETING ROOM RESERVATION</div>
    <nav class="nav">
      <a href="/rooms" class="button">Room Information</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h2 class="title">New Booking</h2>
    <div id="flash" class="flash" style="display:none"></div>

    <form id="bookingForm" method="POST" action="/book" class="grid">
      <!-- Company (Other ì„ íƒ ê°€ëŠ¥) -->
      <label class="field" id="companyField">
        <span>Company</span>
        <select required name="company" id="company"></select>
      </label>

      <label class="field hidden" id="companyOtherField">
        <span>Enter company name</span>
        <input type="text" name="company_other" id="company_other" placeholder="Type company name" />
      </label>

      <label class="field">
        <span>Email</span>
        <input required type="email" name="email" id="email" placeholder="name@example.com" />
      </label>

      <label class="field" id="dateField">
        <span>Date</span>
        <div class="date-field">
          <input required type="date" name="date" id="date" min="2025-10-29" max="2025-10-31" />
          <button class="date-open-btn" type="button" id="openDate" aria-label="Open calendar">ðŸ“…</button>
        </div>
      </label>

      <label class="field">
        <span>Tier</span>
        <input id="tierView" disabled />
        <input type="hidden" name="tier" id="tier" />
      </label>

      <label class="field">
        <span>Room</span>
        <select required name="room" id="room"></select>
      </label>

      <label class="field">
        <span>Start Time</span>
        <select required name="start_hour" id="start"></select>
      </label>

      <label class="field">
        <span>Blocks</span>
        <select required name="blocks" id="blocks">
          <option value="1">1 (60 min)</option>
          <option value="2">2 (120 min)</option>
        </select>
      </label>

      <div class="hint" style="grid-column:1/-1">
        Operating hours <b>09:00â€“18:00</b> Â· Event <b>Oct 29â€“31</b> Â· Max per day per company: <b>2 hours</b>
      </div>

      <!-- âœ… í•˜ë£¨ 2ì‹œê°„ ì œí•œ ê²½ê³  -->
      <div id="dailyWarn" class="flash" style="display:none; grid-column:1/-1"></div>

      <button class="button primary" type="submit" style="grid-column:1/-1">Reserve</button>
      <div id="msg" class="muted" style="grid-column:1/-1"></div>
    </form>
  </section>

  <section class="card board" id="board">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <div style="font-weight:800">Schedule</div>
        <span class="pill" id="boardLabel"></span>
      </div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <div class="muted">Tap an <b>Available</b> row</div>
        <span class="badge">Auto refresh: 1 min</span>
        <span id="lastUpdated" class="badge">Updated: â€”</span>
      </div>
    </div>
    <div class="table-scroll"><div id="boardGrid"></div></div>
  </section>
</main>

<script>
  const EVENT_DATES    = {{ event_dates|tojson|safe }};
  const ALL_ROOMS      = {{ all_room_codes|tojson|safe }};
  const ROOM_LABEL     = {{ room_label|tojson|safe }};
  const ROOMS_BY_TIER  = {{ rooms_by_tier|tojson|safe }};
  const HOURS          = {{ hours|tojson|safe }};
  const MAX_BLOCKS     = {{ max_blocks|tojson|safe }};
  const INITIAL_DATE   = {{ initial_date|tojson|safe }};

  const $ = (s, r=document) => r.querySelector(s);
  const fmt = h => String(h).padStart(2,'0') + ':00';

  let desiredStartFromURL = null;

  // ë‹¬ë ¥
  function openCalendarPicker(){
    const el = $('#date');
    if (el && typeof el.showPicker === 'function') el.showPicker();
    else { el.focus(); el.dispatchEvent(new MouseEvent('mousedown',{bubbles:true})); }
  }
  $('#openDate').addEventListener('click', openCalendarPicker);
  $('#dateField').addEventListener('click',(e)=>{
    if(e.target.id!=='date' && e.target.id!=='openDate') openCalendarPicker();
  });

  // API helpers
  async function apiAvailability(date, room){
    const res = await fetch(`/api/availability?date=${encodeURIComponent(date)}&room=${encodeURIComponent(room)}`);
    if(!res.ok) throw new Error('failed to load availability');
    return await res.json();
  }
  async function apiDailyCheck(date, company){
    const r = await fetch(`/api/daily_check?date=${encodeURIComponent(date)}&company=${encodeURIComponent(company)}`);
    if(!r.ok) return null;
    return await r.json();
  }

  // íšŒì‚¬ ëª©ë¡ + Other
  async function loadCompanies(){
    const r = await fetch('/api/companies');
    const j = await r.json();
    const sel = $('#company');
    const items = j.items || [];
    const opts = items.map(it => `<option value="${it.name}" data-tier="${it.tier}">${it.name}</option>`);
    opts.push(`<option value="Other" data-tier="Other">Other</option>`);
    sel.innerHTML = opts.join('');
  }
  function isOtherSelected(){ return $('#company').value === 'Other'; }

  function roomsForTier(tier){
    const codes = ROOMS_BY_TIER && ROOMS_BY_TIER[tier];
    return Array.isArray(codes) ? codes.slice() : [];
  }

  function populateRooms(codes){
    const sel = $('#room');
    const previous = sel.value;
    const list = Array.isArray(codes) && codes.length ? codes : ALL_ROOMS;
    sel.innerHTML = list.map(code => `<option value="${code}">${ROOM_LABEL[code]||code}</option>`).join('');
    if(previous && list.includes(previous)){
      sel.value = previous;
    } else if(list.length){
      sel.value = list[0];
    }
  }

  function enterOtherMode(){
    $('#companyOtherField').classList.remove('hidden');
    $('#tierView').value = 'Other';
    $('#tier').value = 'Other';
    populateRooms(roomsForTier('Other'));
  }
  function exitOtherMode(){
    $('#companyOtherField').classList.add('hidden');
  }

  function applyTierFromCompany(){
    if(isOtherSelected()){
      enterOtherMode();
      return;
    }
    exitOtherMode();
    const opt = $('#company option:checked');
    const tier = opt?.dataset?.tier || '';
    $('#tierView').value = tier || '(Unknown)';
    $('#tier').value = tier || '';
    const allowed = roomsForTier(tier);
    populateRooms(allowed);
  }

  // ì‹œìž‘ ì˜µì…˜
  function computeStartOptions(taken, blocks){
    const opts = [];
    for(const h of HOURS){
      const end = h + blocks;
      if(end > HOURS[HOURS.length-1] + 1) continue;
      const overlap = (taken||[]).some(([s,e]) => !(end <= s || e <= h));
      if(!overlap) opts.push([h,end]);
    }
    return opts;
  }
  async function refreshStart(){
    const date = $('#date').value;
    const room = $('#room').value;
    const blocks = parseInt($('#blocks').value,10)||1;
    const startSel = $('#start');
    startSel.innerHTML = '';
    if(!date || !room) return;

    try{
      const data = await apiAvailability(date, room);
      const opts = computeStartOptions(data.taken||[], blocks);
      if(!opts.length){
        startSel.innerHTML = `<option value="">No available slots</option>`;
        $('#msg').textContent = 'No available start times for the chosen room/date.';
        return;
      }
      startSel.innerHTML = opts.map(([s,e]) => `<option value="${s}">${fmt(s)} â€“ ${fmt(e)}</option>`).join('');
      if(desiredStartFromURL !== null){
        const found = opts.find(([s]) => s === desiredStartFromURL);
        if(found) $('#start').value = String(desiredStartFromURL);
        desiredStartFromURL = null;
      }
      $('#msg').textContent = '';
    }catch{
      startSel.innerHTML = `<option value="">Failed to load slots</option>`;
    }
  }

  // ë³´ë“œ
  function renderBoard(date, room, data, blocks){
    $('#boardLabel').textContent = `${ROOM_LABEL[room]||room} Â· ${date} Â· Blocks ${blocks}`;
    const busyAt = {};
    const items = data.items || [];
    const disabled = data.disabled || [];
    items.forEach(it => {
      for(let h=it.start_hour; h<it.end_hour; h++){
        busyAt[h] = { type:'booking', company:it.company, tier:it.tier };
      }
    });
    disabled.forEach(slot => {
      for(let h=slot.start_hour; h<slot.end_hour; h++){
        busyAt[h] = { type:'disabled', note: slot.note || '' };
      }
    });
    let html = '<table class="table"><thead><tr><th style="width:160px">Time</th><th>Status</th><th>Company</th></tr></thead><tbody>';
    for(const h of HOURS){
      const entry = busyAt[h];
      const busy = !!entry;
      let status;
      let info = '';
      if (entry && entry.type === 'disabled'){
        status = '<b class="no">Unavailable</b>';
        info = entry.note || 'Blocked by admin';
      } else if (entry){
        status = '<b class="no">Booked</b>';
        info = `${entry.company} (${entry.tier})`;
      } else {
        status = '<b class="ok">Available</b>';
      }
      html += `<tr data-h="${h}" class="${busy ? '' : 'slot-avail'}">
        <td>${fmt(h)} â€“ ${fmt(h+1)}</td>
        <td>${status}</td>
        <td>${info}</td>
      </tr>`;
    }
    html += '</tbody></table>';
    $('#boardGrid').innerHTML = html;

    const lu = $('#lastUpdated'); if(lu) lu.textContent = 'Updated: ' + new Date().toLocaleTimeString();

    $('#boardGrid').querySelectorAll('tr.slot-avail').forEach(tr=>{
      tr.addEventListener('click', ()=>{
        $('#boardGrid').querySelectorAll('tr').forEach(r=>r.classList.remove('slot-picked'));
        tr.classList.add('slot-picked');
        const start = parseInt(tr.getAttribute('data-h'),10);
        $('#start').value = String(start);
        $('#msg').textContent = `Picked ${fmt(start)} as start.`;
      });
      tr.addEventListener('dblclick', ()=>{
        const start = parseInt(tr.getAttribute('data-h'),10);
        $('#start').value = String(start);
        $('#bookingForm').requestSubmit();
      });
    });
  }

  async function refreshAll(){
    const date = $('#date').value || INITIAL_DATE;
    const room = $('#room').value;
    const blocks = parseInt($('#blocks').value,10)||1;
    if(!date || !room) return;
    const data = await apiAvailability(date, room);
    await refreshStart();
    renderBoard(date, room, data, blocks);
  }

  // í•˜ë£¨ 2ì‹œê°„ ì œí•œ ì‚¬ì „ ì•ˆë‚´/ì°¨ë‹¨
  async function checkDailyLimit(){
    const comp = $('#company').value;
    const date = $('#date').value;
    const warn = $('#dailyWarn');
    const btn  = document.querySelector('#bookingForm button[type="submit"]');
    if(!comp || !date){ warn.style.display='none'; btn.disabled=false; return; }

    try{
      const j = await apiDailyCheck(date, comp);
      if(!j || !j.ok){ warn.style.display='none'; btn.disabled=false; return; }
      const limit = j.limit ?? 2;
      const already = j.total ?? 0;
      const want = parseInt($('#blocks').value,10)||1;
      if (already >= limit){
        warn.textContent = `Daily limit: ${comp} already has ${already}h booked on ${date}. Max ${limit}h/day.`;
        warn.style.display = '';
        btn.disabled = true;
      } else if (already + want > limit){
        warn.textContent = `Daily limit: ${comp} has ${already}h on ${date}. You can add only ${limit - already}h more.`;
        warn.style.display = '';
        btn.disabled = true;
      } else {
        warn.style.display = 'none';
        btn.disabled = false;
      }
    }catch(e){
      warn.style.display = 'none';
      btn.disabled = false;
    }
  }

  // ê¸°ë³¸ê°’
  function defaultDate(){
    if (INITIAL_DATE) return INITIAL_DATE;
    const today = new Date().toISOString().slice(0,10);
    if (today >= EVENT_DATES[0] && today <= EVENT_DATES[EVENT_DATES.length-1]) return today;
    return EVENT_DATES[0];
  }
  function initFromURL(){
    const p = new URLSearchParams(location.search);
    if (p.get('ok') === '1'){
      const f = $('#flash'); f.textContent = 'Booking saved successfully.'; f.style.display = '';
    }
    const comp = p.get('company');
    if (comp){ $('#company').value = comp; if (comp === 'Other'){ $('#companyOtherField').classList.remove('hidden'); $('#company_other').value = p.get('company_other') || ''; } }
    $('#date').value = p.get('date') || defaultDate();
    const b = parseInt(p.get('blocks')||'1',10); $('#blocks').value = (b===2?'2':'1');
    const ps = p.get('picked'); if(ps !== null) { try { desiredStartFromURL = parseInt(ps,10); } catch(_){} }
  }

  document.addEventListener('change', async (e)=>{
    if(e.target.id==='company'){
      applyTierFromCompany();
      if(isOtherSelected()) $('#company_other').focus();
      await checkDailyLimit();
      await refreshAll();
    }else if(['date','blocks'].includes(e.target.id)){
      await checkDailyLimit();
      await refreshAll();
    }else if(e.target.id==='room'){
      await refreshAll();
    }
  });

  $('#bookingForm').addEventListener('submit', async (ev)=>{
    // ë§ˆì§€ë§‰ ë°©ì–´ì„ : í”„ëŸ°íŠ¸ ì²´í¬
    await checkDailyLimit();
    const warn = $('#dailyWarn');
    if (warn.style.display !== 'none'){
      ev.preventDefault();
      return false;
    }
    $('#msg').textContent='Submittingâ€¦';
  });

  async function init(){
    await loadCompanies();
    initFromURL();
    applyTierFromCompany();
    await checkDailyLimit();
    refreshAll().catch(()=>{});
    setInterval(refreshAll,60000);
  }
  init();
</script>
</body>
</html>

